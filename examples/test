#!/bin/bash
set -euo pipefail

RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
NORMAL="\e[0;39m"

OK=0
DIFF=0

pad() {
  # pad "text" width
  local s="$1" w="$2"
  printf "%-${w}s" "$s"
}

now_ms() {
  echo $(( $(date +%s%N) / 1000000 ))
}

in_git_worktree() {
  command -v git >/dev/null 2>&1 && git rev-parse --is-inside-work-tree >/dev/null 2>&1
}

# Expectation logic:
# 1) If the .n3 contains a comment like:  # expect-exit: 2  -> use that
# 2) Else, if it contains "=> false" -> expect exit 2
# 3) Else -> expect exit 0
expected_exit_code() {
  local file="$1"
  local line
  if line=$(grep -Em1 '^[[:space:]]*#[: ]*expect-exit:[[:space:]]*[0-9]+' "$file" 2>/dev/null); then
    if [[ "$line" =~ ([0-9]+) ]]; then
      echo "${BASH_REMATCH[1]}"
      return
    fi
  fi
  if grep -Eq '=>[[:space:]]*false\b' "$file"; then
    echo 2
  else
    echo 0
  fi
}

echo -e "${YELLOW}-------------------------------------------------${NORMAL}"
echo -e "${YELLOW}running eyeling examples${NORMAL}"
echo -e "${YELLOW}using $(../eyeling.js -v) and node $(node --version)${NORMAL}"
echo -e "${YELLOW}-------------------------------------------------${NORMAL}"
echo ""

IN_GIT=0
if in_git_worktree; then IN_GIT=1; fi

# In maintainer mode we write expected outputs (tracked) to output/
if [[ $IN_GIT -eq 1 ]]; then
  mkdir -p output
fi

begin="$(now_ms)"

for file in *.n3; do
  printf "%s" "$(pad "$file" 36)"
  start="$(now_ms)"

  expected_rc="$(expected_exit_code "$file")"

  # Decide where we write generated output
  tmp=""
  generated=""
  expected="output/${file}"

  if [[ $IN_GIT -eq 1 ]]; then
    generated="$expected"            # overwrite expected output in working tree
  else
    # npm-installed / no .git: never modify output/ in node_modules
    if [[ ! -f "$expected" ]]; then
      end="$(now_ms)"
      ms=$((end-start))
      echo -en "${YELLOW}$(pad "${ms} ms" 10)${NORMAL} "
      echo -e "${RED}MISSING expected ${expected}${NORMAL}"
      ((++DIFF))
      continue
    fi
    tmp="$(mktemp)"
    generated="$tmp"
  fi

  # Run eyeling, capture exit code without breaking the loop
  rc=0
  if ../eyeling.js "$file" > "$generated"; then
    rc=0
  else
    rc=$?
  fi

  end="$(now_ms)"
  ms=$((end-start))
  echo -en "${YELLOW}$(pad "${ms} ms" 10)${NORMAL} "

  # Compare output
  diff_ok=0
  if [[ $IN_GIT -eq 1 ]]; then
    if git diff --quiet -- "$expected"; then diff_ok=1; fi
  else
    if command -v git >/dev/null 2>&1; then
      if git diff --no-index --quiet -- "$expected" "$generated" >/dev/null 2>&1; then diff_ok=1; fi
    else
      if diff -u "$expected" "$generated" >/dev/null 2>&1; then diff_ok=1; fi
    fi
  fi

  # Decide pass/fail
  if [[ $diff_ok -eq 1 && $rc -eq $expected_rc ]]; then
    if [[ $rc -eq 0 ]]; then
      echo -e "${GREEN}OK${NORMAL}"
    else
      echo -e "${GREEN}OK${NORMAL} (exit ${rc})"
    fi
    ((++OK))
  else
    if [[ $rc -ne $expected_rc ]]; then
      echo -e "${RED}DIFF${NORMAL} (exit ${rc}, expected ${expected_rc})"
    else
      echo -e "${RED}DIFF${NORMAL}"
    fi
    ((++DIFF))

    # In npm mode, show a git-style diff when available (nice UX)
    if [[ $IN_GIT -eq 0 ]]; then
      if command -v git >/dev/null 2>&1; then
        git diff --no-index -- "$expected" "$generated" || true
      else
        diff -u "$expected" "$generated" || true
      fi
    fi
  fi

  # cleanup tmp file
  if [[ -n "$tmp" ]]; then rm -f "$tmp"; fi
done

end="$(now_ms)"
total=$((end-begin))

echo ""
echo -e "${YELLOW}${total} ms${NORMAL} ${GREEN}${OK} OK${NORMAL} ${RED}${DIFF} DIFF${NORMAL}"

if [[ ${DIFF} -eq 0 ]]; then
  exit 0
else
  exit 2
fi

