# -------------------------
# Drone Corridor Planner v2
# -------------------------
#
# Fuel-bounded drone planning in N3: chain quoted-state transitions, aggregate weights,
# and enforce permit/battery constraints while remaining safe under cycles.

@prefix math: <http://www.w3.org/2000/10/swap/math#>.
@prefix list: <http://www.w3.org/2000/10/swap/list#>.
@prefix gps:  <https://eyereasoner.github.io/eye/reasoning/gps/gps-schema#>.
@prefix :     <https://eyereasoner.github.io/eye/reasoning#>.

# ----------------
# current state
# ----------------
:d1 :location :Gent.
:d1 :battery  :full.
:d1 :permit   :none.

# bounded search horizon (7 steps max)
:fuel7 :value (:t :t :t :t :t :t :t).

# -------------------------------------------------
# "map" / action descriptions (as backward rules)
# State = { ?S :location ... . ?S :battery ... . ?S :permit ... . }
# -------------------------------------------------
# two ways to reach Brugge (tradeoff: cost/comfort)
{:map-DRONE gps:description (
  {?S :location :Gent.   ?S :battery :full. ?S :permit ?P.} true
  {?S :location :Brugge. ?S :battery :mid.  ?S :permit ?P.}
  :fly_gent_brugge
  1500.0 0.006 0.99 0.99
)} <= true.

{:map-DRONE gps:description (
  {?S :location :Gent.   ?S :battery ?B.    ?S :permit ?P.} true
  {?S :location :Brugge. ?S :battery ?B.    ?S :permit ?P.}
  :train_gent_brugge
  1700.0 0.012 0.999 0.995
)} <= true.

# via Kortrijk (permit + charging opportunities)
{:map-DRONE gps:description (
  {?S :location :Gent.     ?S :battery :full. ?S :permit ?P.} true
  {?S :location :Kortrijk. ?S :battery :mid.  ?S :permit ?P.}
  :fly_gent_kortrijk
  1600.0 0.007 0.99 0.99
)} <= true.

{:map-DRONE gps:description (
  {?S :location :Kortrijk. ?S :battery :mid.  ?S :permit ?P.} true
  {?S :location :Brugge.   ?S :battery :low.  ?S :permit ?P.}
  :fly_kortrijk_brugge
  1600.0 0.007 0.99 0.99
)} <= true.

# cycle edge (safe due to fuel bound; typically pruned by belief threshold)
{:map-DRONE gps:description (
  {?S :location :Brugge.   ?S :battery :mid.  ?S :permit ?P.} true
  {?S :location :Kortrijk. ?S :battery :low.  ?S :permit ?P.}
  :fly_brugge_kortrijk
  1600.0 0.007 0.985 0.98
)} <= true.

# get permit in Kortrijk (best belief)
{:map-DRONE gps:description (
  {?S :location :Kortrijk. ?S :battery ?B. ?S :permit :none.} true
  {?S :location :Kortrijk. ?S :battery ?B. ?S :permit :yes.}
  :get_zone_permit_kortrijk
  300.0 0.001 0.999 1.0
)} <= true.

# get permit in Brugge (faster, but lower belief)
{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery ?B. ?S :permit :none.} true
  {?S :location :Brugge. ?S :battery ?B. ?S :permit :yes.}
  :buy_permit_brugge
  450.0 0.002 0.98 1.0
)} <= true.

# charging options
{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery :low. ?S :permit ?P.} true
  {?S :location :Brugge. ?S :battery :full. ?S :permit ?P.}
  :quick_charge_brugge
  600.0 0.004 0.999 0.97
)} <= true.

{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery :mid. ?S :permit ?P.} true
  {?S :location :Brugge. ?S :battery :full. ?S :permit ?P.}
  :topup_brugge
  400.0 0.003 0.999 0.98
)} <= true.

{:map-DRONE gps:description (
  {?S :location :Kortrijk. ?S :battery :mid. ?S :permit ?P.} true
  {?S :location :Kortrijk. ?S :battery :full. ?S :permit ?P.}
  :emergency_charge_kortrijk
  500.0 0.003 0.999 0.95
)} <= true.

# to Oostende: three alternatives
# A) restricted corridor: fastest+comfortable, but requires permit=yes and full battery
{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery :full. ?S :permit :yes.} true
  {?S :location :Oostende. ?S :battery :mid. ?S :permit :yes.}
  :cross_corridor_brugge_oostende
  900.0 0.004 0.98 1.0
)} <= true.

# B) public coastline: no permit required, slower
{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery :mid. ?S :permit ?P.} true
  {?S :location :Oostende. ?S :battery :low. ?S :permit ?P.}
  :public_coastline_brugge_oostende
  1300.0 0.006 0.97 0.96
)} <= true.

{:map-DRONE gps:description (
  {?S :location :Brugge. ?S :battery :full. ?S :permit ?P.} true
  {?S :location :Oostende. ?S :battery :mid. ?S :permit ?P.}
  :public_coastline_brugge_oostende
  1200.0 0.006 0.975 0.96
)} <= true.

# C) Kortrijk shortcut: requires permit and full battery; quicker but lower comfort
{:map-DRONE gps:description (
  {?S :location :Kortrijk. ?S :battery :full. ?S :permit :yes.} true
  {?S :location :Oostende. ?S :battery :mid. ?S :permit :yes.}
  :direct_corridor_kortrijk_oostende
  1100.0 0.009 0.955 0.92
)} <= true.


# -------------------------------------------------
# planner: compute all bounded paths
# -------------------------------------------------
# Base: one description is a path (consume 1 fuel token)
{
  (?From ?To (?Act) ?Dur ?Cost ?Bel ?Comf ?FuelIn ?FuelOut) :path true.
}
<=
{
  :map-DRONE gps:description (?From true ?To ?Act ?Dur ?Cost ?Bel ?Comf).
  ?FuelIn list:rest ?FuelOut.
}.

# Recursive: chain one step + rest path, aggregate weights, consume 1 fuel token
{
  (?From ?To ?Actions ?Dur ?Cost ?Bel ?Comf ?FuelIn ?FuelOut) :path true.
}
<=
{
  :map-DRONE gps:description (?From true ?Mid ?Act ?Dur1 ?Cost1 ?Bel1 ?Comf1).

  ?FuelIn list:rest ?FuelMid.
  (?Mid ?To ?RestActs ?Dur2 ?Cost2 ?Bel2 ?Comf2 ?FuelMid ?FuelOut) :path true.

  ((?Act) ?RestActs) list:append ?Actions.

  (?Dur1  ?Dur2)  math:sum     ?Dur.
  (?Cost1 ?Cost2) math:sum     ?Cost.
  (?Bel1  ?Bel2)  math:product ?Bel.
  (?Comf1 ?Comf2) math:product ?Comf.
}.

# -------------------------------------------------
# Query: plans for d1 to Oostende with pruning thresholds
# -------------------------------------------------
{
  :fuel7 :value ?Fuel.

  ({:d1 :location :Gent. :d1 :battery :full. :d1 :permit :none.}
   {:d1 :location :Oostende. :d1 :battery ?B. :d1 :permit ?P.}
   ?Acts ?Dur ?Cost ?Bel ?Comf ?Fuel ?FuelLeft) :path true.

  ?Bel  math:greaterThan 0.94.
  ?Cost math:lessThan    0.03.
}
=>
{
  :d1 gps:plan (?Acts ?Dur ?Cost ?Bel ?Comf ?B ?P ?FuelLeft).
}.

